# Approval Interface Service

Human-in-the-loop approval interface for AI-generated content in the FIAP AI-Enhanced Learning Platform.

## Overview

This service provides a unified interface for professors and coordinators to review, edit, and approve all actions generated by AI agents. It ensures human oversight and control over AI-generated content such as code reviews, grading, awards, and educational materials.

## Features

- **Unified Dashboard**: View all pending approvals in one place
- **Preview & Edit**: Review AI-generated content and make inline edits before approval
- **Chat with Agents**: Interactive conversation with AI agents for adjustments
- **One-Click Approval**: Quick approval workflow with audit trail
- **Bulk Operations**: Approve multiple items at once
- **History & Audit**: Complete log of all approvals and edits
- **Statistics**: Real-time metrics on approval throughput and rates

## Architecture

### Tech Stack

- **Framework**: FastAPI (Python 3.11+)
- **Architecture**: Serverless-ready microservice
- **Database**: DynamoDB (with in-memory fallback for testing)
- **Authentication**: JWT-based (integrates with auth_service)
- **API Style**: RESTful with standard response format

### Structure

```
approval_interface/
├── src/
│   ├── main.py              # FastAPI application
│   ├── api/                 # API routes
│   │   └── approvals.py     # Approval endpoints
│   ├── models/              # Pydantic data models
│   │   └── approval.py      # ApprovalItem, ApprovalDecision, etc.
│   ├── services/            # Business logic
│   │   └── approval_service.py
│   └── repositories/        # Data access layer
│       ├── base.py          # Repository interface
│       └── dynamodb.py      # DynamoDB implementation
├── tests/
│   ├── conftest.py          # Test fixtures
│   ├── test_api.py          # API endpoint tests
│   └── test_services.py     # Service layer tests
├── requirements.txt
├── requirements-dev.txt
└── README.md
```

## API Endpoints

### Approval Operations

- `GET /api/v1/approvals/pending` - List pending approvals with filters
- `GET /api/v1/approvals/{id}` - Get approval details
- `POST /api/v1/approvals` - Create new approval item
- `PUT /api/v1/approvals/{id}/edit` - Edit approval content
- `POST /api/v1/approvals/{id}/approve` - Approve item
- `POST /api/v1/approvals/{id}/reject` - Reject item with reason
- `POST /api/v1/approvals/bulk-approve` - Bulk approval

### Chat & History

- `POST /api/v1/approvals/{id}/chat` - Send message to AI agent
- `GET /api/v1/approvals/{id}/chat` - Get chat history
- `GET /api/v1/approvals/history` - Get approval history

### Statistics

- `GET /api/v1/approvals/stats` - Get approval statistics

### Health

- `GET /` - Service info
- `GET /health` - Health check

## Installation & Setup

### Prerequisites

- Python 3.11+
- pip or poetry

### Local Development

```bash
# Navigate to service directory
cd src/apps/approval_interface

# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
pip install -r requirements-dev.txt

# Run the service
uvicorn src.main:app --reload --port 8000
```

The service will be available at `http://localhost:8000`

API documentation: `http://localhost:8000/docs`

## Testing

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src --cov-report=html

# Run specific test file
pytest tests/test_api.py -v

# Run specific test
pytest tests/test_services.py::test_approve_item -v
```

## Code Quality

```bash
# Format code
black .
isort .

# Lint
flake8 .

# Type checking
mypy src/
```

## Data Models

### ApprovalItem

Main approval entity with the following key fields:

- `approval_id`: Unique identifier
- `type`: Type of approval (code_review, grading, award, content, issue)
- `status`: Current status (pending, in_review, approved, rejected)
- `priority`: Priority level (critical, high, normal, low)
- `generated_content`: AI-generated content (JSON)
- `assigned_to`: Professor/coordinator user ID

### ApprovalStatus

- `PENDING`: Awaiting review
- `IN_REVIEW`: Being reviewed
- `APPROVED`: Approved and executed
- `REJECTED`: Rejected with reason

### ApprovalType

- `CODE_REVIEW`: GitHub code review feedback
- `GRADING`: Student work grading
- `AWARD`: Prize/award rankings
- `CONTENT`: Generated educational content (videos, etc.)
- `ISSUE`: Content review issues

## Usage Examples

### Create Approval

```python
import httpx

async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/v1/approvals",
        json={
            "type": "code_review",
            "related_id": "review_12345",
            "title": "Code Review for Student Project",
            "description": "AI-generated code review",
            "generated_content": {
                "feedback": "Good code structure...",
                "score": 85
            },
            "assigned_to": "prof_001",
            "priority": "high"
        }
    )
    approval = response.json()["data"]
    print(f"Created: {approval['approval_id']}")
```

### List Pending

```python
response = await client.get(
    "http://localhost:8000/api/v1/approvals/pending",
    params={"user_id": "prof_001", "priority": "high"}
)
items = response.json()["data"]
print(f"Found {len(items)} pending items")
```

### Approve Item

```python
response = await client.post(
    f"http://localhost:8000/api/v1/approvals/{approval_id}/approve",
    json={"approved_by": "prof_001"}
)
print("Approved!")
```

## Integration

### With Other Services

This service integrates with:

- **auth_service**: For authentication and authorization
- **code_review_agent**: Receives code review approvals
- **grading_agent**: Receives grading approvals
- **content_generator_agent**: Receives content approvals
- **award_methodology_agent**: Receives award approvals

### Triggering Actions

When an approval is approved, the service triggers appropriate actions:

- **Code reviews**: Post comment to GitHub
- **Grading**: Publish grades to system
- **Content**: Upload to YouTube/platform
- **Awards**: Publish rankings

These integrations are placeholder implementations in the current version.

## Environment Variables

```bash
# AWS Configuration (for production DynamoDB)
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret

# Service Configuration
PORT=8000
LOG_LEVEL=INFO

# Authentication (JWT)
JWT_SECRET_KEY=your_secret_key
```

## Deployment

### Serverless (AWS Lambda)

This service is designed to run as AWS Lambda functions:

1. Package the application
2. Deploy via Serverless Framework or AWS SAM
3. Configure API Gateway
4. Set environment variables

See deployment documentation for detailed instructions.

## Roadmap

See [roadmap.md](roadmap.md) for the complete implementation plan including:

- Frontend Flutter integration
- Real-time notifications
- Mobile support
- Advanced analytics
- Multi-tenant support

## Contributing

Follow the repository's coding standards:

- Use `black` for formatting (line length 88)
- Type hints required
- Docstrings for all public functions (Google style)
- Write tests for new features
- Maintain 80%+ code coverage

## License

Part of FIAP AI-Enhanced Learning Platform - Global Solution 2025.2

## Support

For issues or questions, contact the development team or open an issue in the repository.
